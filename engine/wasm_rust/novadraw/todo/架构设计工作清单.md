# Novadraw 架构设计工作清单

## 架构目标

将当前单 crate 项目拆分为多层库结构，参考 Eclipse Draw2D/GEF 设计理念：

```
┌─────────────────────────────────────────────────────────────┐
│                    Novadraw 架构拆分                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Level 1: 核心库 (无运行时依赖)                              │
│  ├── novadraw-math/  纯数学库 (Vec2, Mat3, Affine)          │
│  └── novadraw-core/  核心类型 (Color, Id)                   │
│                                                             │
│  Level 2: 渲染层 (依赖 Level 1)                              │
│  └── novadraw-render/ 渲染抽象层 + Vello 后端               │
│                                                             │
│  Level 3: 场景层 (依赖 Level 1 + 2) - Draw2D 定位           │
│  └── novadraw-scene/  Figure 系统 + 场景图 + 视口           │
│                                                             │
│  Level 4: 编辑器层 (依赖 Level 3) - GEF 定位                │
│  └── novadraw-gef/    EditPart + Command + Tools           │
│                                                             │
│  Apps: 应用层                                                │
│  ├── novadraw-winit/  桌面应用                              │
│  └── novadraw-web/    Web 应用                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 阶段 A：创建数学库 (novadraw-math)

### A.1 创建基础结构

- [ ] 创建 `novadraw-math/` 目录
- [ ] 创建 `Cargo.toml` (workspace.member)
- [ ] 创建 `src/lib.rs`

### A.2 迁移数学类型

- [ ] 创建 `src/vec2.rs` - DVec2 包装类型
- [ ] 创建 `src/vec3.rs` - DVec3 包装类型
- [ ] 创建 `src/mat3.rs` - 3x3 矩阵
- [ ] 创建 `src/rect.rs` - Rect, Point, Size 结构
- [ ] 创建 `src/transform/` 子模块
    - [ ] `mod.rs` - 模块入口
    - [ ] `affine.rs` - AffineTransform (仿射变换)

### A.3 验证

- [ ] 编译 `cargo build -p novadraw-math`
- [ ] 运行单元测试

---

## 阶段 B：创建核心库 (novadraw-core)

### B.1 创建基础结构

- [ ] 创建 `novadraw-core/` 目录
- [ ] 创建 `Cargo.toml` (workspace.member)
- [ ] 创建 `src/lib.rs`

### B.2 迁移类型

- [ ] 迁移 `src/color.rs` - Color 结构
- [ ] 定义公共导出 (re-exports from math)

### B.3 验证

- [ ] 编译 `cargo build -p novadraw-core`
- [ ] 运行单元测试

---

## 阶段 C：创建渲染库 (novadraw-render)

### C.1 创建基础结构

- [ ] 创建 `novadraw-render/` 目录
- [ ] 创建 `Cargo.toml` (依赖 novadraw-math)
- [ ] 创建 `src/lib.rs`

### C.2 迁移渲染抽象层

- [ ] 创建 `src/command.rs` - RenderCommand IR
- [ ] 创建 `src/context.rs` - RenderContext
- [ ] 创建 `src/traits.rs` - Renderer, WindowProxy traits

### C.3 迁移后端实现

- [ ] 创建 `src/backend/` 子模块
- [ ] 创建 `src/backend/mod.rs` - 条件导出
- [ ] 迁移 `src/backend/vello/` - Vello 后端
    - [ ] `mod.rs` - VelloRenderer
    - [ ] `winit.rs` - WinitWindowProxy

### C.4 验证

- [ ] 编译 `cargo build -p novadraw-render --features vello`
- [ ] 运行单元测试

---

## 阶段 D：创建场景库 (novadraw-scene)

### D.1 创建基础结构

- [ ] 创建 `novadraw-scene/` 目录
- [ ] 创建 `Cargo.toml` (依赖 novadraw-math, novadraw-render)
- [ ] 创建 `src/lib.rs`

### D.2 迁移 Figure 系统

- [ ] 创建 `src/figure/` 子模块
    - [ ] `mod.rs` - Figure trait, NullFigure
    - [ ] `basic.rs` - RectangleFigure, EllipseFigure, LineFigure
    - [ ] `path.rs` - PathFigure (贝塞尔路径)
    - [ ] `text.rs` - TextFigure (可选)

### D.3 迁移场景图

- [ ] 创建 `src/scene/` 子模块
    - [ ] `mod.rs` - SceneGraph
    - [ ] `block.rs` - RuntimeBlock, BlockType
    - [ ] `layer.rs` - Layer, LayerType (Grid/Content/Handles/Feedback)

### D.4 迁移其他组件

- [ ] 迁移 `src/viewport.rs` - Viewport
- [ ] 创建 `src/layout/` 子模块 (可选)
    - [ ] `mod.rs` - LayoutManager trait
    - [ ] `flow.rs` - FlowLayout
    - [ ] `xy.rs` - XYLayout

### D.5 验证

- [ ] 编译 `cargo build -p novadraw-scene --features vello`
- [ ] 运行单元测试

---

## 阶段 E：更新主 crate (novadraw)

### E.1 重构主 crate

- [ ] 清空 `novadraw/src/` (保留空模块作为 re-export)
- [ ] 更新 `Cargo.toml` (移除已迁移的依赖，添加 workspace 成员引用)

### E.2 更新应用

- [ ] 更新 `apps/editor/Cargo.toml` (依赖 novadraw-scene)
- [ ] 更新导入路径
- [ ] 验证编译和运行

---

## 阶段 F：创建 GEF 库 (novadraw-gef) - 未来

### F.1 创建基础结构

- [ ] 创建 `novadraw-gef/` 目录
- [ ] 创建 `Cargo.toml` (依赖 novadraw-scene)
- [ ] 创建 `src/lib.rs`

### F.2 实现 EditPart

- [ ] 创建 `src/editpart/` 子模块
    - [ ] `mod.rs` - EditPart trait
    - [ ] `graphical.rs` - GraphicalEditPart
    - [ ] `tree.rs` - TreeEditPart

### F.3 实现 EditPolicy

- [ ] 创建 `src/editpolicy/` 子模块
    - [ ] `mod.rs` - EditPolicy trait
    - [ ] `selection.rs` - SelectionEditPolicy
    - [ ] `drag.rs` - DragEditPolicy
    - [ ] `connection.rs` - ConnectionEditPolicy

### F.4 实现 Command

- [ ] 创建 `src/command/` 子模块
    - [ ] `mod.rs` - Command trait
    - [ ] `basic.rs` - BasicCommand
    - [ ] `compound.rs` - CompoundCommand
    - [ ] `history.rs` - CommandHistory (撤销/重做)

### F.5 实现 Tools

- [ ] 创建 `src/tool/` 子模块
    - [ ] `mod.rs` - Tool trait
    - [ ] `selection.rs` - SelectionTool
    - [ ] `marquee.rs` - MarqueeSelectionTool
    - [ ] `direct_edit.rs` - DirectEditTool

### F.6 实现其他组件

- [ ] 创建 `src/editdomain.rs` - EditDomain
- [ ] 创建 `src/action/` - Action 系统

### F.7 验证

- [ ] 编译 `cargo build -p novadraw-gef`
- [ ] 运行单元测试

---

## 阶段 G：应用层扩展 (可选)

### G.1 WebAssembly 支持

- [ ] 创建 `novadraw-web/` 目录
- [ ] 集成 web-sys + wasm-bindgen
- [ ] Canvas 渲染适配

### G.2 移动端支持 (未来)

- [ ] 创建 `novadraw-android/` (可选)
- [ ] 创建 `novadraw-ios/` (可选)

---

## 迁移对照表

| 当前文件/目录 | 新位置 |
|--------------|--------|
| `novadraw/src/core/` | → `novadraw-math/` |
| `novadraw/src/core/color.rs` | → `novadraw-core/src/color.rs` |
| `novadraw/src/core/transform.rs` | → `novadraw-math/src/transform/` |
| `novadraw/src/render/` | → `novadraw-render/src/` |
| `novadraw/src/render/command.rs` | → `novadraw-render/src/command.rs` |
| `novadraw/src/render/context.rs` | → `novadraw-render/src/context.rs` |
| `novadraw/src/render/traits.rs` | → `novadraw-render/src/traits.rs` |
| `novadraw/src/backend/vello/` | → `novadraw-render/src/backend/vello/` |
| `novadraw/src/scene/` | → `novadraw-scene/src/` |
| `novadraw/src/scene/figure/` | → `novadraw-scene/src/figure/` |
| `novadraw/src/scene/mod.rs` | → `novadraw-scene/src/scene/` |
| `novadraw/src/viewport.rs` | → `novadraw-scene/src/viewport.rs` |
| (新增) | → `novadraw-gef/src/` |
| `apps/editor/` | → `novadraw-winit/` |

---

## 验证清单 (每个阶段)

- [ ] 代码编译无错误
- [ ] 单元测试通过
- [ ] 集成测试通过 (如果存在)
- [ ] 文档更新 (README.md, API 文档)
- [ ] 依赖版本锁定 (Cargo.lock)

---

## 执行优先级

| 优先级 | 阶段 | 说明 |
|--------|------|------|
| P0 | A, B | 基础数学库，依赖最少 |
| P1 | C | 渲染层，核心依赖 |
| P2 | D | 场景层，编辑器核心 |
| P3 | E | 更新主 crate，整合所有变更 |
| P4 | F | GEF 层，未来扩展 |
| P5 | G | Web 支持，可选 |

---

## 注意事项

1. **保持 API 兼容性**：迁移时保持 public API 签名一致
2. **渐进式迁移**：每阶段完成后验证，再进行下一阶段
3. **文档同步**：每个新库都需要 README.md
4. **版本管理**：使用 workspace 版本统一管理
5. **CI/CD**：更新 GitHub Actions 以支持多 crate 构建

---

## 参考资料

- [Eclipse Draw2D 文档](https://www.eclipse.org/gef/draw2d/)
- [Eclipse GEF 文档](https://www.eclipse.org/gef/)
- [Rust Workspace 文档](https://doc.rust-lang.org/cargo/reference/workspaces.html)
- [Cargo Features 最佳实践](https://doc.rust-lang.org/cargo/reference/features.html)
