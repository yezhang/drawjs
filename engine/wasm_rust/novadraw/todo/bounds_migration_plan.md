# Bounds è¿ç§»è®¡åˆ’

æœ¬æ–‡æ¡£è®°å½•å°†æœ¬é¡¹ç›®çš„ Figure bounds ç³»ç»Ÿè¿ç§»åˆ°ä¸ Eclipse Draw2D ä¸€è‡´æ‰€éœ€çš„æ”¹è¿›é¡¹ã€‚

## 1. å½“å‰å®ç° vs d2 å®Œæ•´èƒ½åŠ›å¯¹æ¯”

### 1.1 Bounds ç›¸å…³èƒ½åŠ›å¯¹æ¯”

| èƒ½åŠ›                    | d2 å®ç°                                  | æœ¬é¡¹ç›®å®ç°               | å·®è·        |
| ----------------------- | ---------------------------------------- | ------------------------ | ----------- |
| **bounds å­˜å‚¨**         | Rectangle (x,y,width,height)             | Rect (x,y,width,height)  | âœ… å·²å®ç°   |
| **bounds å«ä¹‰**         | ç»å¯¹åæ ‡ï¼ˆç›¸å¯¹äºåæ ‡æ ¹ï¼‰                 | ç»å¯¹åæ ‡ï¼ˆç›¸å¯¹äºåæ ‡æ ¹ï¼‰ | âœ… å·²å®ç°   |
| **åæ ‡ä¼ æ’­**            | `primTranslate()` è‡ªåŠ¨ä¼ æ’­åˆ°å­èŠ‚ç‚¹       | âœ… SceneGraph å®ç°       | âœ… å·²å®ç°   |
| **useLocalCoordinates** | æ”¯æŒåˆ‡æ¢åæ ‡æ¨¡å¼                         | âœ… å·²å®ç°                 | âœ… å·²å®ç°   |
| **åæ ‡æ ¹æ¦‚å¿µ**          | ScalableFreeformLayeredPane, Viewport ç­‰ | âœ… æ”¯æŒæ£€æµ‹               | âš ï¸ éƒ¨åˆ†å®ç° |
| **translateFromParent** | é€’å½’åæ ‡è½¬æ¢                             | â³ å¾…å®ç°                 | âŒ æœªå®ç°   |
| **translateToParent**   | é€’å½’åæ ‡è½¬æ¢                             | â³ å¾…å®ç°                 | âŒ æœªå®ç°   |

### 1.2 Figure Trait èƒ½åŠ›å¯¹æ¯”

| æ–¹æ³•                            | d2  | æœ¬é¡¹ç›® | çŠ¶æ€         |
| ------------------------------- | --- | ------ | ------------ |
| `bounds()`                      | âœ…  | âœ…     | å·²å®ç°       |
| `setBounds()`                   | âœ…  | â³     | è¿›è¡Œä¸­       |
| `containsPoint()`               | âœ…  | âœ…     | å·²å®ç°       |
| `hit_test()`                    | âœ…  | âœ…     | å·²å®ç°       |
| `useLocalCoordinates()`         | âœ…  | âœ…     | å·²å®ç°       |
| `translate(int,int)`            | âœ…  | âœ…     | SceneGraph   |
| `primTranslate(int,int)`        | âœ…  | âœ…     | SceneGraph   |
| `translateFromParent()`         | âœ…  | â³     | å¾…å®ç°       |
| `translateToParent()`           | âœ…  | â³     | å¾…å®ç°       |
| `translateToAbsolute()`         | âœ…  | âœ…     | SceneGraph   |
| `translateToRelative()`         | âœ…  | âŒ     | æœªå®ç°       |
| `isCoordinateSystem()`          | âœ…  | âœ…     | SceneGraph   |
| `getClientArea()`               | âœ…  | âœ…     | éƒ¨åˆ†å®ç°     |
| `getInsets()`                   | âœ…  | âœ…     | æœ‰å®šä¹‰       |
| `isOpaque()`                    | âœ…  | âœ…     | å·²å®ç°       |
| `fireFigureMoved()`             | âœ…  | âŒ     | æœªå®ç°       |
| `fireCoordinateSystemChanged()` | âœ…  | âŒ     | æœªå®ç°       |

### 1.3 å¸ƒå±€ç›¸å…³èƒ½åŠ›å¯¹æ¯”

| èƒ½åŠ›             | d2  | æœ¬é¡¹ç›® | çŠ¶æ€   |
| ---------------- | --- | ------ | ------ |
| LayoutManager    | âœ…  | âœ…     | å·²å®ç° |
| setConstraints   | âœ…  | âœ…     | å·²å®ç° |
| invalidate()     | âœ…  | éƒ¨åˆ†   | éœ€å®Œå–„ |
| validate()       | âœ…  | éƒ¨åˆ†   | éœ€å®Œå–„ |
| revalidate()     | âœ…  | âŒ     | æœªå®ç° |
| invalidateTree() | âœ…  | âŒ     | æœªå®ç° |

### 1.4 å‘½ä¸­æµ‹è¯•èƒ½åŠ›å¯¹æ¯”

| èƒ½åŠ›                   | d2  | æœ¬é¡¹ç›® | çŠ¶æ€     |
| ---------------------- | --- | ------ | -------- |
| findFigureAt           | âœ…  | âŒ     | æœªå®ç°   |
| findMouseEventTargetAt | âœ…  | âœ…     | å·²å®ç°   |
| é€†åºéå†å­èŠ‚ç‚¹         | âœ…  | âœ…     | å·²å®ç°   |
| åæ ‡è½¬æ¢               | âœ…  | âš ï¸     | éƒ¨åˆ†å®ç° |
| è·¯å¾„è¿½è¸ª               | âœ…  | âœ…     | å·²å®ç°   |
| å‰ªæï¼ˆclientAreaï¼‰     | âœ…  | âŒ     | æœªå®ç°   |
| TreeSearch è¿‡æ»¤        | âœ…  | âŒ     | æœªå®ç°   |

---

## 2. æ‰§è¡Œæ¸…å•

### é˜¶æ®µ 1ï¼šåŸºç¡€åæ ‡ç³»ç»Ÿï¼ˆçŸ­æœŸï¼‰

| #   | ä»»åŠ¡                                                | ä¼˜å…ˆçº§ | çŠ¶æ€         |
| --- | --------------------------------------------------- | ------ | ------------ |
| 1.1 | ä¿®å¤å‘½ä¸­æµ‹è¯•åæ ‡è½¬æ¢ï¼ˆå½“å‰æµ‹è¯•å¤±è´¥ï¼‰                | P0     | âœ… completed |
| 1.2 | å®ç° `translate()` åæ ‡ä¼ æ’­ï¼Œç»Ÿä¸€ bounds ä¸ºç»å¯¹åæ ‡ | P1     | âœ… completed |
| 1.3 | å®ç° `setBounds()` æ–¹æ³•å’Œ erase/repaint è¯­ä¹‰        | P2     | ğŸ”„ in_progress |

### é˜¶æ®µ 2ï¼šåæ ‡è½¬æ¢æ–¹æ³•ï¼ˆä¸­æœŸï¼‰

| #   | ä»»åŠ¡                                                      | ä¼˜å…ˆçº§ | çŠ¶æ€         |
| --- | --------------------------------------------------------- | ------ | ------------ |
| 2.1 | å®ç° `translateFromParent/translateToParent` åæ ‡è½¬æ¢æ–¹æ³• | P3     | â³ pending   |
| 2.2 | å®ç° `translateToAbsolute/translateToRelative` é€’å½’è½¬æ¢   | P4     | âœ… completed |

### é˜¶æ®µ 3ï¼šå¸ƒå±€å¤±æ•ˆæœºåˆ¶ï¼ˆä¸­æœŸï¼‰

| #   | ä»»åŠ¡                                                     | ä¼˜å…ˆçº§ | çŠ¶æ€       |
| --- | -------------------------------------------------------- | ------ | ---------- |
| 3.1 | å®ç° `invalidate/revalidate/invalidateTree` å¸ƒå±€å¤±æ•ˆæœºåˆ¶ | P5     | â³ pending |

### é˜¶æ®µ 4ï¼šåæ ‡æ ¹ä¸æœ¬åœ°åæ ‡æ¨¡å¼ï¼ˆé•¿æœŸï¼‰

| #   | ä»»åŠ¡                                                                   | ä¼˜å…ˆçº§ | çŠ¶æ€       |
| --- | ---------------------------------------------------------------------- | ------ | ---------- |
| 4.1 | å®ç° `isCoordinateSystem()` æ–¹æ³•                                       | P6     | â³ pending |
| 4.2 | å®ç°åæ ‡æ ¹å®¹å™¨ï¼ˆFreeformLayer, Viewport, ScalableFreeformLayeredPaneï¼‰ | P6     | â³ pending |

### é˜¶æ®µ 5ï¼šé«˜çº§å‘½ä¸­æµ‹è¯•ï¼ˆé•¿æœŸï¼‰

| #   | ä»»åŠ¡                                   | ä¼˜å…ˆçº§ | çŠ¶æ€       |
| --- | -------------------------------------- | ------ | ---------- |
| 5.1 | å®ç° `findFigureAt` å’Œ TreeSearch è¿‡æ»¤ | P7     | â³ pending |
| 5.2 | å®ç°åŸºäº `getClientArea()` çš„å‰ªæ      | P7     | â³ pending |

---

## 3. ä»»åŠ¡è¯¦æƒ…

### 1.1 ä¿®å¤å‘½ä¸­æµ‹è¯•åæ ‡è½¬æ¢ï¼ˆå½“å‰æµ‹è¯•å¤±è´¥ï¼‰

**é—®é¢˜**ï¼šå½“å‰å‘½ä¸­æµ‹è¯•ä¸­åµŒå¥—åœºæ™¯æµ‹è¯•å¤±è´¥ï¼Œè·¯å¾„æœªæ­£ç¡®è¿½è¸ª

**æ ¹å› åˆ†æ**ï¼š

- å­èŠ‚ç‚¹ bounds æ˜¯ç›¸å¯¹äºçˆ¶èŠ‚ç‚¹çš„
- å‘½ä¸­æµ‹è¯•éœ€è¦å°†å…¨å±€åæ ‡è½¬æ¢ä¸ºæœ¬åœ°åæ ‡
- å½“å‰åç§»é‡è®¡ç®—é€»è¾‘æœ‰è¯¯

**é¢„æœŸè¡Œä¸º**ï¼š

```
åœºæ™¯ï¼šroot(100,100) â†’ parent(30,30) â†’ child(-30,-30)
ç‚¹å‡»ç‚¹ (120, 120) åº”è¯¥å‘½ä¸­ child

ç»å¯¹åæ ‡ï¼š
- root: (100, 100, 200, 150)
- parent: (130, 130, 100, 80)
- child: (100, 100, 60, 40)  // 130-30=100, 130-30=100
```

**å…³é”®ä»£ç è·¯å¾„**ï¼š

- `novadraw-scene/src/scene/hit_test.rs` - HitTester

---

### 1.2 å®ç° primTranslate() åæ ‡ä¼ æ’­ âœ… å·²å®Œæˆ

**ç›®æ ‡**ï¼šç»Ÿä¸€ bounds å«ä¹‰ä¸ºç»å¯¹åæ ‡ï¼Œçˆ¶èŠ‚ç‚¹ç§»åŠ¨æ—¶è‡ªåŠ¨ä¼ æ’­åˆ°å­èŠ‚ç‚¹

**å®ç°ä½ç½®**ï¼š`SceneGraph::prim_translate(block_id, dx, dy)`

**è®¾è®¡**ï¼š

```rust
// SceneGraph ä¸­å®ç°
pub fn prim_translate(&mut self, block_id: BlockId, dx: f64, dy: f64) {
    // ä½¿ç”¨æ˜¾å¼æ ˆè¿­ä»£å®ç°ï¼Œé¿å…é€’å½’æ ˆæº¢å‡º
    let mut stack = vec![block_id];

    while let Some(id) = stack.pop() {
        if let Some(block) = self.blocks.get_mut(id) {
            // ä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„ bounds (x, y)
            if let Some(rect) = block.figure.as_rectangle_mut() {
                rect.bounds.x += dx;
                rect.bounds.y += dy;
            }

            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æœ¬åœ°åæ ‡æ¨¡å¼
            if block.figure.use_local_coordinates() {
                // æœ¬åœ°åæ ‡æ¨¡å¼ï¼šä¸ä¼ æ’­
                continue;
            }

            // é»˜è®¤æ¨¡å¼ï¼šå°†æ‰€æœ‰å­èŠ‚ç‚¹åŠ å…¥æ ˆè¿›è¡Œå¹³ç§»
            for &child_id in &block.children {
                stack.push(child_id);
            }
        }
    }
}
```

**å·²å®ç°æ–¹æ³•**ï¼š

- `prim_translate()` - åŸå§‹å¹³ç§»ï¼Œä¼ æ’­åˆ°å­èŠ‚ç‚¹
- `translate_to_absolute()` - è·å–èŠ‚ç‚¹çš„ç»å¯¹ä½ç½®
- `is_coordinate_system()` - æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ˜¯åæ ‡æ ¹

**å½±å“èŒƒå›´**ï¼š

- å­èŠ‚ç‚¹ bounds å§‹ç»ˆä¿æŒç»å¯¹åæ ‡ï¼ˆç›¸å¯¹äºåæ ‡æ ¹ï¼‰
- ä½¿ç”¨æ˜¾å¼æ ˆé¿å…é€’å½’æ ˆæº¢å‡º

---

### 1.3 å®ç° setBounds() æ–¹æ³•

**ç›®æ ‡**ï¼šå®ç°å®Œæ•´çš„ bounds è®¾ç½®è¯­ä¹‰

**è®¾è®¡**ï¼š

```rust
fn set_bounds(&mut self, rect: Rect) {
    let old_x = self.bounds.x;
    let old_y = self.bounds.y;

    let resize = rect.width != self.bounds.width || rect.height != self.bounds.height;
    let translate = rect.x != old_x || rect.y != old_y;

    if (resize || translate) && self.is_visible {
        self.erase();  // æ“¦é™¤æ—§ä½ç½®
    }

    if translate {
        let dx = rect.x - old_x;
        let dy = rect.y - old_y;
        self.prim_translate(dx, dy);
    }

    self.bounds = rect;

    if translate || resize {
        if resize {
            self.invalidate();
        }
        self.fire_figure_moved();
        self.repaint();
    }
}
```

---

## 4. ä¼˜å…ˆçº§è¯´æ˜

| ä¼˜å…ˆçº§ | å«ä¹‰       | é€‚ç”¨åœºæ™¯                      |
| ------ | ---------- | ----------------------------- |
| P0     | æœ€é«˜ä¼˜å…ˆçº§ | ä¿®å¤æµ‹è¯•å¤±è´¥ï¼Œå½±å“æ ¸å¿ƒåŠŸèƒ½    |
| P1     | é«˜ä¼˜å…ˆçº§   | åŸºç¡€ API ç¼ºå¤±ï¼Œå½±å“ç³»ç»Ÿä¸€è‡´æ€§ |
| P2     | ä¸­é«˜ä¼˜å…ˆçº§ | å¸¸ç”¨ APIï¼Œå½±å“ç”¨æˆ·ä½“éªŒ        |
| P3     | ä¸­ä¼˜å…ˆçº§   | å®Œæ•´ APIï¼Œæ”¯æŒé«˜çº§åŠŸèƒ½        |
| P4     | ä¸­ä¼˜å…ˆçº§   | å®Œæ•´ APIï¼Œæ”¯æŒé«˜çº§åŠŸèƒ½        |
| P5     | ä¸­ä½ä¼˜å…ˆçº§ | å¸ƒå±€ç³»ç»Ÿå®Œæ•´                  |
| P6     | ä½ä¼˜å…ˆçº§   | é«˜çº§ç‰¹æ€§ï¼Œæ”¯æŒç¼©æ”¾/æ»šåŠ¨       |
| P7     | ä½ä¼˜å…ˆçº§   | é«˜çº§ç‰¹æ€§ï¼Œæ”¯æŒè¿‡æ»¤            |

---

## 5. ä¾èµ–å…³ç³»

```
1.1 ä¿®å¤å‘½ä¸­æµ‹è¯•        âœ… å·²å®Œæˆ
    â”‚
    â–¼
1.2 primTranslate       âœ… å·²å®Œæˆ
    â”‚
    â–¼
1.3 setBounds()         ğŸ”„ è¿›è¡Œä¸­
    â”‚
    â–¼
2.1 translateFromParent â³ pending
    â”‚
    â–¼
2.2 translateToAbsolute âœ… å·²å®Œæˆ
    â”‚
    â–¼
3.1 å¸ƒå±€å¤±æ•ˆæœºåˆ¶        â³ pending
    â”‚
    â–¼
4.1 isCoordinateSystem  â³ pending
    â”‚
    â–¼
4.2 åæ ‡æ ¹å®¹å™¨          â³ pending
    â”‚
    â–¼
5.1 é«˜çº§å‘½ä¸­æµ‹è¯•        â³ pending
```

---

## 6. éªŒæ”¶æ ‡å‡†

æ¯ä¸ªä»»åŠ¡å®Œæˆåéœ€æ»¡è¶³ï¼š

1. **å•å…ƒæµ‹è¯•é€šè¿‡** - æ‰€æœ‰ç›¸å…³æµ‹è¯• 100% é€šè¿‡
2. **ç¼–è¯‘æ— è­¦å‘Š** - `cargo clippy` æ— è­¦å‘Š
3. **API æ–‡æ¡£å®Œæ•´** - æ‰€æœ‰ pub æ–¹æ³•æœ‰æ–‡æ¡£æ³¨é‡Š
4. **è¡Œä¸ºä¸ d2 ä¸€è‡´** - å…³é”®è¡Œä¸ºä¸ Eclipse Draw2D ç›¸åŒ

---

_åˆ›å»ºæ—¶é—´ï¼š2024-01-15_
_åŸºäº Eclipse Draw2D æºç åˆ†æ_
